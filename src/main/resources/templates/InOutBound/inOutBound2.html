<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout1}">
<head>
    <!-- CSS files for DataTables -->
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/autofill/2.7.0/css/autoFill.bootstrap5.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.bootstrap5.min.css"/>
</head>
<body>
<th:block layout:fragment="style">
    <style>
        .dt-search {
            display: flex;
            margin-top: 10px;
        }
        .h2-header {
            margin-top: 50px;
        }
        .align-items-center .form-group label {
            margin-right: 10px;
        }
        .input-with-info small {
            position: absolute;
            left: 0;
            top: 100%;
            white-space: nowrap;
        }
        .modal-custom {
            max-width: 50%;
        }
        .modal-body-scrollable {
            max-height: 600px;
            overflow-y: auto;
        }
        .product-field-row .col {
            margin-right: 10px;
            top: 10px;
        }
        .product-field-row .col-auto {
            display: flex;
            align-items: center;
            margin-left: auto;
            position: relative;
            top: 10px;
        }
        .modal-body {
            padding: 15px;
        }
        .delivery-date-group input {
            margin-right: 10px;
        }
        .delivery-date-group button {
            white-space: nowrap;
        }
        .order-search-table th {
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            width: 10%;
        }
        .order-search-table td {
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            width: 10%;
        }
        .order-search-table input {
            width: 50%;
            box-sizing: border-box;
        }
    </style>
</th:block>
<th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/autofill/2.7.0/js/dataTables.autoFill.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdn.datatables.net/select/2.0.3/js/dataTables.select.min.js"></script>
    <script src="https://cdn.datatables.net/select/2.0.3/js/select.dataTables.min.js"></script>
    <script>
        $(document).ready(function () {
            loadMaterialData();
            loadProductData();
            setTodayDate();
            loadTransactionData(); // 초기 로드 시 트랜잭션 데이터 로드
            $('#categoryInbound').on('change', function () {
                toggleSelectBox($(this).val(), 'inbound');
            });
            $('#categoryOutbound').on('change', function () {
                toggleSelectBox($(this).val(), 'outbound');
            });
            toggleSelectBox($('#categoryInbound').val(), 'inbound');
            toggleSelectBox($('#categoryOutbound').val(), 'outbound');
            $('#addInboundForm').on('submit', function (event) {
                event.preventDefault();
                addInbound();
            });
            $('#addOutboundForm').on('submit', function (event) {
                event.preventDefault();
                addOutbound();
            });
            $('#transactionTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'excel', 'pdf'
                ],
                responsive: true,
                destroy: true,
                select: true,
                ordering: true,
                scrollX: true,
                info: true,
                paging: true,
                language: {
                    search: "검색:"
                }
            });
        });
        function loadMaterialData() {
            $.ajax({
                url: '/api/materials',
                method: 'GET',
                success: function (response) {
                    var materials = response.data;
                    var materialSelectInbound = $('#materialNameInbound');
                    var materialSelectOutbound = $('#materialNameOutbound');
                    materialSelectInbound.empty();
                    materialSelectOutbound.empty();
                    materials.forEach(function (item) {
                        var option = '<option value="' + item.materialCode + '">' + item.materialName + '</option>';
                        materialSelectInbound.append(option);
                        materialSelectOutbound.append(option);
                    });
                },
                error: function (error) {
                    console.error('Error fetching material data:', error);
                }
            });
        }
        function loadProductData() {
            $.ajax({
                url: '/api/products',
                method: 'GET',
                success: function (response) {
                    var products = response.data;
                    var productSelectInbound = $('#productNameInbound');
                    var productSelectOutbound = $('#productNameOutbound');
                    productSelectInbound.empty();
                    productSelectOutbound.empty();
                    products.forEach(function (item) {
                        var option = '<option value="' + item.productCode + '">' + item.productName + '</option>';
                        productSelectInbound.append(option);
                        productSelectOutbound.append(option);
                    });
                },
                error: function (error) {
                    console.error('Error fetching product data:', error);
                }
            });
        }
        function setTodayDate() {
            var today = new Date().toISOString().split('T')[0];
            $('#inboundDate').val(today);
            $('#outboundDate').val(today);
        }
        function toggleSelectBox(category, type) {
            if (category === 'product') {
                $('#' + type + 'MaterialName').hide();
                $('#' + type + 'ProductName').show();
            } else if (category === 'material') {
                $('#' + type + 'ProductName').hide();
                $('#' + type + 'MaterialName').show();
            }
        }
        function addInbound() {
            var selectedCategory = $('#categoryInbound').val();
            var selectedCode = selectedCategory === 'product' ? $('#productNameInbound').val() : $('#materialNameInbound').val();
            var inboundData = {
                materialCode: selectedCategory === 'material' ? selectedCode : null,
                productCode: selectedCategory === 'product' ? selectedCode : null,
                transactionDate: $('#inboundDate').val() + 'T00:00:00',
                transactionType: 'IN',
                quantity: $('#inboundQuantity').val(),
                manager: $('#inboundManager').val()
            };
            $.ajax({
                url: '/api/inoutbound/inbound',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(inboundData),
                success: function () {
                    $('#addInboundModal').modal('hide');
                    $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                    loadTransactionData();  // 재조회
                },
                error: function (error) {
                    console.error('Error adding inbound:', error);
                }
            });
        }
        function addOutbound() {
            var selectedCategory = $('#categoryOutbound').val();
            var selectedCode = selectedCategory === 'product' ? $('#productNameOutbound').val() : $('#materialNameOutbound').val();
            var outboundData = {
                materialCode: selectedCategory === 'material' ? selectedCode : null,
                productCode: selectedCategory === 'product' ? selectedCode : null,
                transactionDate: $('#outboundDate').val() + 'T00:00:00',
                transactionType: 'OUT',
                quantity: $('#outboundQuantity').val(),
                manager: $('#outboundManager').val()
            };
            $.ajax({
                url: '/api/inoutbound/outbound',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(outboundData),
                success: function () {
                    $('#addOutboundModal').modal('hide');
                    $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                    loadTransactionData();  // 재조회
                },
                error: function (error) {
                    console.error('Error adding outbound:', error);
                }
            });
        }
        function loadTransactionData() {
            $.ajax({
                url: '/api/inoutbound/all', // 트랜잭션 데이터 전체를 가져오는 엔드포인트
                method: 'GET',
                success: function (data) {
                    var table = $('#transactionTable').DataTable();
                    table.clear();
                    data.forEach(function (item) {
                        var code = item.materialCode ? item.materialCode : item.productCode;
                        var name = item.materialName ? item.materialName : item.productName;
                        table.row.add([
                            code,
                            name,
                            item.transactionDate,
                            item.transactionType,
                            item.quantity,
                            item.manager
                        ]).draw();
                    });
                },
                error: function (error) {
                    console.error('Error fetching transaction data:', error);
                }
            });
        }
    </script>
</th:block>
<div layout:fragment="content">
    <div class="main-panel">
        <div class="container-fluid">
            <h1 class="h2-header">Transaction Management</h1>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addInboundModal">Add Inbound</button>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addOutboundModal">Add Outbound</button>
            <table class="table table-bordered" id="transactionTable">
                <thead>
                <tr>
                    <th>Material/Product Code</th>
                    <th>Material/Product Name</th>
                    <th>Transaction Date</th>
                    <th>Transaction Type</th>
                    <th>Quantity</th>
                    <th>Manager</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <!-- Add Inbound Modal -->
        <div class="modal fade" id="addInboundModal" tabindex="-1" role="dialog" aria-labelledby="addInboundModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addInboundModalLabel">Add Inbound</h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addInboundForm">
                            <div class="form-group">
                                <label for="categoryInbound">Category</label>
                                <select class="form-control" id="categoryInbound" required>
                                    <option value="product">Product</option>
                                    <option value="material">Material</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productNameInbound" id="labelProductNameInbound">Product Name</label>
                                <select class="form-control" id="productNameInbound" required style="display: none;"></select>
                                <label for="materialNameInbound" id="labelMaterialNameInbound">Material Name</label>
                                <select class="form-control" id="materialNameInbound" required></select>
                            </div>
                            <div class="form-group">
                                <label for="inboundDate">Inbound Date</label>
                                <input type="date" class="form-control" id="inboundDate" required>
                            </div>
                            <div class="form-group">
                                <label for="inboundQuantity">Quantity</label>
                                <input type="number" class="form-control" id="inboundQuantity" required>
                            </div>
                            <div class="form-group">
                                <label for="inboundManager">Manager</label>
                                <input type="text" class="form-control" id="inboundManager" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Outbound Modal -->
        <div class="modal fade" id="addOutboundModal" tabindex="-1" role="dialog" aria-labelledby="addOutboundModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addOutboundModalLabel">Add Outbound</h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addOutboundForm">
                            <div class="form-group">
                                <label for="categoryOutbound">Category</label>
                                <select class="form-control" id="categoryOutbound" required>
                                    <option value="product">Product</option>
                                    <option value="material">Material</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productNameOutbound" id="labelProductNameOutbound">Product Name</label>
                                <select class="form-control" id="productNameOutbound" required style="display: none;"></select>
                                <label for="materialNameOutbound" id="labelMaterialNameOutbound">Material Name</label>
                                <select class="form-control" id="materialNameOutbound" required></select>
                            </div>
                            <div class="form-group">
                                <label for="outboundDate">Outbound Date</label>
                                <input type="date" class="form-control" id="outboundDate" required>
                            </div>
                            <div class="form-group">
                                <label for="outboundQuantity">Quantity</label>
                                <input type="number" class="form-control" id="outboundQuantity" required>
                            </div>
                            <div class="form-group">
                                <label for="outboundManager">Manager</label>
                                <input type="text" class="form-control" id="outboundManager" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>