<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout1}">

<th:block layout:fragment="style">
    <style>
        .dt-search {
            display: flex;
            margin-top: 10px;
        }

        .order-search-table th, .shipping-status-table th {
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            width: 10%;
        }

        .order-search-table td, .shipping-status-table td {
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            width: 10%;
        }

        .order-search-table input, .shipping-status-table input {
            width: 50%;
            box-sizing: border-box;
        }
    </style>
</th:block>

<th:block layout:fragment="script">
    <script>
        var table2 = null;
        var table3 = null;

        $(document).ready(function () {
            // 출하 관리 테이블 (COMPLETED 상태인 수주 정보만 표시)
            table2 = $('#table2').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'colvis',
                        text: "선택",
                    },
                    {
                        extend: 'copy',
                        text: "복사",
                    },
                    {
                        extend: 'excel',
                        text: "엑셀다운로드",
                    },
                ],
                select: true,
                searching: true,
                responsive: true,
                destroy: true,
                processing: true,
                serverSide: false,
                ordering: true,
                scrollX: true,
                info: false,
                ajax: {
                    url: 'http://localhost:8080/Shipping/orders',
                    type: 'GET',
                    dataFilter: function (res) {
                        var json = $.parseJSON(res);
                        return JSON.stringify({
                            'draw': json.draw,
                            'recordsTotal': json.recordsTotal,
                            'recordsFiltered': json.recordsFiltered,
                            'data': json.data,
                        });
                    }
                },
                columns: [
                    {
                        title: "<input type='checkbox' id='select-all'/>",
                        data: null,
                        defaultContent: '',
                        orderable: false,
                        className: 'select-checkbox',
                        render: function (data, type, row) {
                            return '<input type="checkbox" class="select-row"/>';
                        }
                    },
                    {title: "수주번호", data: 'orderNumber'},
                    {title: "업체명", data: 'client'},
                    {title: "상태", data: 'status'},
                    {title: "담당자", data: 'manager'},
                    {
                        title: "수주 확정일", data: 'updateTime', render: function (data, type, row) {
                            var date = new Date(data);
                            var year = date.getFullYear();
                            var month = ('0' + (date.getMonth() + 1)).slice(-2);
                            var day = ('0' + date.getDate()).slice(-2);
                            var hours = ('0' + date.getHours()).slice(-2);
                            var minutes = ('0' + date.getMinutes()).slice(-2);
                            return `${year}-${month}-${day} ${hours}:${minutes}`;
                        }
                    },
                    {title: "전화번호", data: 'phoneNumber'},
                    {title: "납품일", data: 'deliveryDate'},
                    {
                        title: "운송업체",
                        data: null,
                        render: function (data, type, row) {
                            return `
                                <select class="shipping-company">
                                    <option value="company1">Company 1</option>
                                    <option value="company2">Company 2</option>
                                    <option value="company3">Company 3</option>
                                </select>
                            `;
                        }
                    }
                ],
                language: {
                    search: "검색:",
                    emptyTable: "선택된 수주 정보가 없습니다",
                    zeroRecords: "검색 결과가 없습니다"
                },
                rowCallback: function (row, data) {
                    if (data.status !== 'COMPLETED') {
                        $(row).hide();
                    }
                }
            });

            // 출하 현황 테이블 (PendingShipment, SHIPPED 상태인 수주 정보만 표시)
            table3 = $('#table3').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'colvis',
                        text: "선택",
                    },
                    {
                        extend: 'copy',
                        text: "복사",
                    },
                    {
                        extend: 'excel',
                        text: "엑셀다운로드",
                    },
                ],
                searching: true,
                responsive: true,
                destroy: true,
                processing: true,
                serverSide: false,
                ordering: true,
                scrollX: true,
                info: false,
                ajax: {
                    url: 'http://localhost:8080/Shipping/shippingStatus',
                    type: 'GET',
                    dataFilter: function (res) {
                        console.log(res);
                        var json = $.parseJSON(res);
                        return JSON.stringify({
                            'draw': json.draw,
                            'recordsTotal': json.recordsTotal,
                            'recordsFiltered': json.recordsFiltered,
                            'data': json.data,
                        });
                    }
                },
                columns: [
                    {title: "수주번호", data: 'orderNumber'},
                    {title: "출하일", data: 'shippingDate'},
                    {title: "출하상태", data: 'shippingStatus'},
                    {title: "운송업체", data: 'shippingCompany'}
                ],
                language: {
                    search: "검색:",
                    emptyTable: "출하된 정보가 없습니다",
                    zeroRecords: "검색 결과가 없습니다"
                },
                rowCallback: function (row, data) {
                    if (data.shippingStatus !== 'PendingShipment' && data.shippingStatus !== 'SHIPPED') {
                        $(row).hide();
                    }
                }
            });

            // Select/Deselect all checkboxes
            $('#select-all').on('click', function(){
                var rows = table2.rows({ 'search': 'applied' }).nodes();
                $('input[type="checkbox"]', rows).prop('checked', this.checked);
            });

            $('#btn-update-status').on('click', function() {
                var selectedData = [];
                table2.$('input[type="checkbox"]').each(function(){
                    if (this.checked) {
                        var row = $(this).closest('tr');
                        var shippingCompany = row.find('.shipping-company').val();
                        selectedData.push({
                            orderNumber: table2.row(row).data().orderNumber,
                            shippingCompany: shippingCompany
                        });
                    }
                });
                updateStatusAndCreateShipping(selectedData);
            });
        });

        function updateStatusAndCreateShipping(selectedData) {
            var data = selectedData.map(function(row) {
                return {
                    orderNumber: row.orderNumber,
                    shippingCompany: row.shippingCompany,
                    shippingDate: new Date().toISOString().split('T')[0] // 오늘 날짜
                };
            });

            $.ajax({
                url: 'http://localhost:8080/Shipping/updateAndCreate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    table2.ajax.reload();
                    table3.ajax.reload(); // 출하 현황 테이블도 갱신
                },
                error: function(xhr, status, error) {
                    alert('상태 업데이트 실패: ' + error);
                }
            });
        }
    </script>
</th:block>

<div layout:fragment="content">
    <div class="main-panel">
        <div class="container-fluid">
            <h2 class="h2-header">출하 현황</h2>
            <table id="table3" class="table table-striped table-bordered shipping-status-table"></table>

            <h2 class="h2-header">출하 관리</h2>
            <table id="table2" class="table table-striped table-bordered order-search-table"></table>
            <button id="btn-update-status">출하</button>
        </div>
    </div>
</div>
</html>
