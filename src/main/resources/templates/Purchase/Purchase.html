<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout1}">

<th:block layout:fragment="style">
    <style>
        .dt-search {
            display: flex;
            margin-top: 10px;
        }

        .h2-header {
            margin-top: 50px;
        }

        .align-items-center .form-group label {
            margin-right: 10px;
        }

        .align-items-center .form-group .form-control {
            margin-right: 10px;
        }

        .form-row > .col-auto {
            margin-right: 10px;
        }

        .form-row > .col-auto:last-child {
            margin-right: 0;
        }

        .input-with-info small {
            position: absolute;
            left: 0;
            top: 100%;
        }

        .modal-custom {
            max-width: 50%;
        }

        .modal-body-scrollable {
            max-height: 600px;
            overflow-y: auto;
        }

        .product-field-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .product-field-row .col {
            margin-right: 10px;
            top: 10px;
        }

        .product-field-row .col-auto {
            display: flex;
            align-items: center;
            margin-left: auto;
            position: relative;
            top: 10px;
        }

        #calendar {
            width: 100%;
            height: 100%;
            max-height: 600px;
        }

        .modal-body {
            padding: 15px;
        }

        .modal-lg {
            max-width: 80%;
        }

        .delivery-date-group {
            display: flex;
            align-items: center;
        }

        .delivery-date-group input {
            margin-right: 10px;
        }

        .order-search-table th, .order-search-table td {
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }

        .order-search-table input {
            width: 50%;
            box-sizing: border-box;
        }

        #excelFile {
            display: none;
        }

        .custom-file-upload {
            display: inline-block;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #26962f;
            color: #ffffff;
            border: 1px solid #62e19a;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }

        .custom-file-upload:hover {
            background-color: #34ad3e;
        }
    </style>
</th:block>

<th:block layout:fragment="script">
    <script>
        let productBOM = {
            "양배추즙": {"양배추": 4, "벌꿀": 0.15, "정제수": 1.95, "포장지": 30},
            "흑마늘즙": {"흑마늘": 4, "벌꿀": 0.15, "정제수": 1.95, "포장지": 30},
            "석류젤리스틱": {"석류농축액": 0.125, "콜라겐": 0.05, "정제수": 0.2, "포장지": 25},
            "매실젤리스틱": {"매실농축액": 0.125, "콜라겐": 0.05, "정제수": 0.2, "포장지": 25}
        };

        $(document).ready(function () {
            var orderTable = $('#orderTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                select: {
                    style: 'multi',
                    selector: 'td:first-child input[type="checkbox"]'
                },
                ajax: {
                    url: '/api/purchase-order/orders-not-in-purchase',
                    dataSrc: ''
                },
                columns: [
                    {
                        data: null,
                        defaultContent: '<input type="checkbox">',
                        orderable: false,
                        className: 'select-checkbox'
                    },
                    {data: 'orderNumber'},
                    {data: 'client'},
                    {data: 'deliveryDate'},
                    {data: 'phoneNumber'},
                    {data: 'manager'}
                ],
                language: {
                    search: "검색:",
                    emptyTable: "선택된 수주 정보가 없습니다",
                    zeroRecords: "검색 결과가 없습니다"
                }
            });

            var orderItemsTable = $('#orderItemsTable').DataTable({
                columns: [
                    {data: 'orderNumber'},
                    {data: 'productName'},
                    {data: 'amount'}
                ],
                language: {
                    emptyTable: "선택된 제품 정보가 없습니다"
                }
            });

            var totalProductsTable = $('#totalProductsTable').DataTable({
                columns: [
                    {data: 'productName'},
                    {data: 'totalAmount'}
                ],
                language: {
                    emptyTable: "선택된 제품 정보가 없습니다"
                }
            });

            $('#orderTable tbody').on('click', 'tr', function () {
                var data = orderTable.row(this).data();
                if (data) {
                    $.ajax({
                        url: "/api/purchase-order/orderItems/" + data.orderNumber,
                        method: "GET",
                        success: function (response) {
                            response.forEach(item => item.orderNumber = data.orderNumber);
                            orderItemsTable.clear().rows.add(response).draw();
                        },
                        error: function () {
                            alert("Error fetching order items");
                        }
                    });
                }
            });

            $('#calculateTotals').on('click', function () {
                var selectedOrderNumbers = [];
                orderTable.rows({selected: true}).data().each(function (row) {
                    selectedOrderNumbers.push(row.orderNumber);
                });

                if (selectedOrderNumbers.length > 0) {
                    $.ajax({
                        url: "/api/purchase-order/calculateTotals",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(selectedOrderNumbers),
                        success: function (response) {
                            totalProductsTable.clear().rows.add(response).draw();
                        },
                        error: function () {
                            alert("Error calculating totals");
                        }
                    });
                } else {
                    alert("Please select at least one order");
                }
            });

            $('#orderButton').on('click', function (e) {
                e.preventDefault(); // 기본 동작 방지

                console.log('발주 버튼 클릭됨');

                // 모달 열기
                var materialModal = new bootstrap.Modal(document.getElementById('materialModal'));
                materialModal.show();

                var materialRequirements = {};
                $('#totalProductsTable tbody tr').each(function () {
                    var productName = $(this).find('td').eq(0).text();
                    var quantity = parseInt($(this).find('td').eq(1).text());

                    var materials = productBOM[productName];
                    for (var material in materials) {
                        var requiredAmount = materials[material] * quantity;
                        materialRequirements[material] = (materialRequirements[material] || 0) + requiredAmount;
                    }
                });

                var tbody = $('#materialRequirementTable tbody');
                tbody.empty();
                for (var material in materialRequirements) {
                    tbody.append(`<tr><td>${material}</td><td>${materialRequirements[material].toFixed(2)}</td></tr>`);
                }

                // 데이터 계산 후 모달 열기
                $('#materialModal').modal('show');
            });
            $('#select-all').on('click', function () {
                var rows = orderTable.rows({'search': 'applied'}).nodes();
                $('input[type="checkbox"]', rows).prop('checked', this.checked);
                if (this.checked) {
                    orderTable.rows().select();
                } else {
                    orderTable.rows().deselect();
                }
            });

            $('#orderTable tbody').on('change', 'input[type="checkbox"]', function () {
                var el = $('#select-all').get(0);
                if (el && el.checked && ('indeterminate' in el)) {
                    el.indeterminate = true;
                }
            });

            // 모달 초기화
            $('#materialModal').modal({
                show: false
            });
        });
    </script>
</th:block>

<div layout:fragment="content">
    <div class="main-panel">
        <div class="container-fluid">
            <h2 class="h2-header">자재 발주 페이지</h2>
            <table id="orderTable" class="table table-striped table-bordered order-search-table">
                <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>수주번호</th>
                    <th>수주처</th>
                    <th>납품일</th>
                    <th>전화번호</th>
                    <th>담당자</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <h2 class="mt-5">제품명과 수량</h2>
            <table id="orderItemsTable" class="table table-striped table-bordered order-search-table">
                <thead>
                <tr>
                    <th>수주번호</th>
                    <th>제품명</th>
                    <th>수량</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <h2 class="mt-5">총 제품 수량</h2>
            <button id="calculateTotals" class="btn btn-primary">총 수량 계산</button>
            <button id="orderButton" class="btn btn-success" data-toggle="modal" data-target="#materialModal">발주</button>
            <table id="totalProductsTable" class="table table-striped table-bordered order-search-table">
                <thead>
                <tr>
                    <th>제품명</th>
                    <th>총 수량</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Material Modal -->
<div class="modal fade" id="materialModal" tabindex="-1" role="dialog" aria-labelledby="materialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="materialModalLabel">자재 필요량</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table id="materialRequirementTable" class="table table-striped">
                    <thead>
                    <tr>
                        <th>자재</th>
                        <th>필요 수량</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
</html>
